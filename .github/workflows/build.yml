name: Build haunted2600-ps2

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    name: Compile ELF per PlayStation 2
    runs-on: ubuntu-latest
    container:
      image: ps2dev/ps2dev:latest

    # Setta le variabili a livello di job, disponibili in TUTTI gli step
    env:
      PS2DEV: /usr/local/ps2dev
      PS2SDK: /usr/local/ps2dev/ps2sdk
      PATH: /usr/local/ps2dev/ee/bin:/usr/local/ps2dev/iop/bin:/usr/local/ps2dev/dvp/bin:/usr/local/ps2dev/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verifica toolchain
        run: |
          echo "PATH=$PATH"
          which ee-gcc
          ee-gcc --version

      - name: Compila ELF
        run: make -j$(nproc)

      - name: Verifica ELF
        run: |
          ls -lh haunted2600.elf
          ee-size haunted2600.elf

      - name: Upload haunted2600.elf
        uses: actions/upload-artifact@v4
        with:
          name: haunted2600-ps2-elf
          path: haunted2600.elf
          retention-days: 30

      - name: Crea Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: haunted2600.elf
          name: haunted2600-ps2 ${{ github.ref_name }}
          body: |
            ## Haunted House Atari 2600 Emulator per PS2
            Metti la ROM in `mass:/roms/haunted_house.bin` e avvia con FreeMCBoot.
            **Controlli:** D-Pad=Joystick | Croce=Fuoco | START=Reset | SELECT=Select
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
