name: Build PS2 Atari 2600 Emulator

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    container:
      image: ps2dev/ps2dev:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apk add --no-cache make git bash zip

    - name: Check gsKit
      run: |
        echo "Checking gsKit location..."
        find /usr/local/ps2dev -name "gsKit.h" 2>/dev/null || echo "gsKit.h not found"
        find /usr/local/ps2dev -name "libgskit.a" 2>/dev/null || echo "libgskit.a not found"
        ls -la /usr/local/ps2dev/gsKit/include/ 2>/dev/null || echo "gsKit include dir not found"
        ls -la /usr/local/ps2dev/ps2sdk/ports/include/ 2>/dev/null || echo "ports include dir not found"

    - name: Build emulator
      run: |
        export PS2SDK=/usr/local/ps2dev/ps2sdk
        export GSKIT=/usr/local/ps2dev/gsKit
        export PATH="/usr/local/ps2dev/bin:/usr/local/ps2dev/ee/bin:/usr/local/ps2dev/iop/bin:$PATH"
        make clean
        make

    - name: Package release
      run: |
        mkdir -p release
        cp atari2600.elf release/
        echo "Atari 2600 Emulator for PS2" > release/README.txt
        echo "" >> release/README.txt
        echo "Put game.bin on USB root" >> release/README.txt
        echo "USB must be FAT32" >> release/README.txt

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: atari2600-ps2
        path: release/
        retention-days: 90
